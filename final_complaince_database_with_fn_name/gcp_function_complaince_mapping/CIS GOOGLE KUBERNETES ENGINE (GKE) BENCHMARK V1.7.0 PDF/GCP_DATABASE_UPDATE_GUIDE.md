# GCP Function Database Update Guide

## Overview

This guide explains how to update the `gcp_simplified_function_names.json` database with new functions and rename suggestions generated by the GCP compliance mapper.

## Current Database Status

- **Original functions**: 4,662
- **New functions added**: 60 (from CIS GKE compliance mapping)
- **Functions renamed**: 5 (IAM service account → GKE workload identity)
- **Total functions**: 4,721
- **Database size**: ~2.4MB

## File Structure

```
CIS GOOGLE KUBERNETES ENGINE (GKE) BENCHMARK V1.7.0 PDF/
├── gcp_simplified_function_names.json                    # Main function database
├── update_gcp_function_database.py                       # Basic update script
├── update_gcp_function_database_flexible.py              # Flexible update script (recommended)
├── output/
│   ├── new_functions/                                    # New suggested functions
│   │   └── gcp_new_functions_20250821_043824.json       # 60 new GKE functions
│   ├── updated_functions/                                # Function rename suggestions
│   │   └── gcp_rename_functions_20250821_043824.json    # 5 rename suggestions
│   └── updated_compliance/                               # Updated compliance mappings
└── gcp_simplified_function_names.json.backup_*           # Backup files
```

## Update Process

### 1. Automatic Update (Recommended)

Use the flexible update script that automatically finds the latest output files:

```bash
python3 update_gcp_function_database_flexible.py
```

**Features:**
- Automatically detects latest output files by timestamp
- Creates backup before making changes
- Handles both new functions and rename suggestions
- Provides detailed logging and summary

### 2. Manual Update

Use the basic update script with specific file paths:

```bash
python3 update_gcp_function_database.py
```

**Features:**
- Uses hardcoded file paths
- Same functionality as flexible script
- Good for testing specific files

## What Gets Updated

### New Functions Added (60 functions)

The mapper generated 60 new GKE-specific functions covering:

- **GKE Cluster Security**: Proxy kubeconfig, kubelet configuration, authentication
- **GKE Authorization**: Cluster admin roles, RBAC, service accounts
- **GKE Networking**: VPC native, private endpoints, network policies
- **GKE Node Security**: Shielded nodes, auto-upgrade, integrity monitoring
- **Container Security**: Image scanning, binary authorization, workload identity

**Example new function:**
```json
{
  "sheet": "CIS_GKE",
  "rule_id": "CIS_GKE_1",
  "description": "Checks if the proxy kubeconfig file permissions are set to 644 or more restrictive",
  "function_name": "gke_proxy_kubeconfig_file_permission_restricted",
  "service_category": "Compute",
  "confidence": 7,
  "gcp_sdk_example": "gcloud container clusters describe --format='get(nodeConfig.proxyConfig)' --project=PROJECT_ID"
}
```

### Functions Renamed (5 functions)

The mapper suggested renaming IAM service account functions to be more GKE-specific:

| Old Name | New Name | Rationale |
|----------|----------|-----------|
| `iam_service_account_no_admin_privileges` | `gke_workload_identity_no_admin_privileges` | Focus on GKE workload identity |
| `iam_service_account_no_owner_role` | `gke_workload_identity_no_owner_role` | Focus on GKE workload identity |
| `iam_service_account_no_owner_role_key` | `gke_workload_identity_no_owner_role_key` | Focus on GKE workload identity |
| `iam_service_account_no_admin_access` | `gke_workload_identity_no_admin_access` | Focus on GKE workload identity |
| `iam_service_account_no_editor_owner_roles` | `gke_workload_identity_no_editor_owner_roles` | Focus on GKE workload identity |

## Database Format

The updated database maintains the same structure as the original:

```json
{
  "sheet": "CIS_GKE",                    // Source framework
  "rule_id": "CIS_GKE_1",               // Rule identifier
  "description": "Function description", // Detailed description
  "function_name": "function_name",      // Snake_case function name
  "service_category": "Compute",         // GCP service category
  "confidence": 7,                       // Confidence score (1-10)
  "gcp_sdk_example": "gcloud command"    // Implementation example
}
```

## Backup and Safety

### Automatic Backups

Both scripts create automatic backups before making changes:

- **Backup naming**: `gcp_simplified_function_names.json.backup_YYYYMMDD_HHMMSS`
- **Backup location**: Same directory as original file
- **Backup content**: Complete copy of original database

### Recovery

To restore from backup:

```bash
# Find latest backup
ls -la gcp_simplified_function_names.json.backup_*

# Restore from backup
cp gcp_simplified_function_names.json.backup_YYYYMMDD_HHMMSS gcp_simplified_function_names.json
```

## Validation

### Verify Updates

After running the update script, verify the changes:

```bash
# Check total function count
grep -c '"function_name"' gcp_simplified_function_names.json

# Check for new GKE functions
grep -c "gke_" gcp_simplified_function_names.json

# Check for renamed functions
grep -c "gke_workload_identity" gcp_simplified_function_names.json
```

### Expected Results

- **Total functions**: 4,721 (was 4,662)
- **GKE functions**: 60 new functions
- **Renamed functions**: 5 functions updated
- **File size**: ~2.4MB (increased by ~22KB)

## Integration with Compliance Mapper

### Running the Mapper

After updating the database, you can run the compliance mapper again:

```bash
# Test mode (recommended first)
python3 gcp_compliance_mapper.py gcp_simplified_function_names.json "CIS GOOGLE KUBERNETES ENGINE (GKE) BENCHMARK V1.7.0 PDF.json" --test 15

# Production mode
python3 gcp_compliance_mapper.py gcp_simplified_function_names.json "CIS GOOGLE KUBERNETES ENGINE (GKE) BENCHMARK V1.7.0 PDF.json"
```

### Expected Improvements

With the updated database, the mapper should show:

- **Better coverage**: More existing functions mapped to compliance requirements
- **Fewer new functions needed**: Reduced gaps in coverage
- **Higher confidence scores**: Better quality mappings

## Troubleshooting

### Common Issues

1. **File not found errors**
   - Ensure you're in the correct directory
   - Check that output files exist in `output/` subdirectories

2. **JSON parsing errors**
   - Verify output files are valid JSON
   - Check for encoding issues

3. **No changes applied**
   - Functions may already exist in database
   - Rename suggestions may have been applied previously

### Debug Mode

Add debug logging to see detailed information:

```python
# In the update script, change logging level to DEBUG
logging.basicConfig(level=logging.DEBUG)
```

## Best Practices

1. **Always run in test mode first** when using the compliance mapper
2. **Review new functions** before applying updates
3. **Keep backups** of important database versions
4. **Validate changes** after each update
5. **Use the flexible script** for automatic file detection

## Future Updates

When new compliance mapper runs generate additional output files:

1. **New functions**: Will be automatically detected and added
2. **Rename suggestions**: Will be automatically applied
3. **Backups**: Will be created for each update
4. **Validation**: Script will prevent duplicate additions

The flexible update script will automatically find the latest output files and apply all changes safely.
