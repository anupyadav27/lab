# GCP Foundation Function Database Update Guide

## Overview

This guide explains how to update the `gcp_simplified_function_names.json` database with new functions and rename suggestions generated by the GCP Foundation compliance mapper.

## Current Database Status

- **Original functions**: 4,662
- **New functions added**: 13 (from CIS GCP Foundation compliance mapping)
- **Functions renamed**: 0 (no rename suggestions in this run)
- **Total functions**: 4,672
- **Database size**: ~2.4MB

## File Structure

```
CIS_GOOGLE_CLOUD_PLATFORM_FOUNDATION_BENCHMARK_V4.0.0/
├── gcp_simplified_function_names.json                    # Main function database
├── update_gcp_function_database_flexible.py              # Flexible update script (recommended)
├── output/
│   ├── new_functions/                                    # New suggested functions
│   │   └── gcp_new_functions_20250821_002753.json       # 13 new Foundation functions
│   ├── updated_functions/                                # Function rename suggestions (empty)
│   └── updated_compliance/                               # Updated compliance mappings
└── gcp_simplified_function_names.json.backup_*           # Backup files
```

## Update Process

### Automatic Update (Recommended)

Use the flexible update script that automatically finds the latest output files:

```bash
python3 update_gcp_function_database_flexible.py
```

**Features:**
- Automatically detects latest output files by timestamp
- Creates backup before making changes
- Handles both new functions and rename suggestions
- Provides detailed logging and summary
- Handles cases where no rename suggestions exist

## What Gets Updated

### New Functions Added (13 functions)

The mapper generated 13 new GCP Foundation-specific functions covering:

- **IAM & Identity**: Corporate login credentials, service account roles, API key restrictions
- **Cloud Functions**: Environment variables security, Secret Manager integration
- **Logging & Monitoring**: Log sinks, project ownership change alerts
- **Security**: Cloud Asset Inventory, Access Transparency
- **Networking**: Default networks, legacy networks, DNS security
- **Compute**: OS Login, BigQuery data classification

**Example new function:**
```json
{
  "sheet": "CIS_GCP_FOUNDATION",
  "rule_id": "CIS_GCP_FOUNDATION_1",
  "description": "Checks if corporate login credentials are used instead of consumer accounts",
  "function_name": "iam_user_corporate_login_used",
  "service_category": "Identity",
  "confidence": 7,
  "gcp_sdk_example": "gcloud iam service-accounts list --project=PROJECT_ID"
}
```

### Functions Renamed (0 functions)

No rename suggestions were generated in this compliance mapping run, which is normal for the Foundation benchmark.

## Database Format

The updated database maintains the same structure as the original:

```json
{
  "sheet": "CIS_GCP_FOUNDATION",          // Source framework
  "rule_id": "CIS_GCP_FOUNDATION_1",     // Rule identifier
  "description": "Function description",  // Detailed description
  "function_name": "function_name",       // Snake_case function name
  "service_category": "Identity",         // GCP service category
  "confidence": 7,                        // Confidence score (1-10)
  "gcp_sdk_example": "gcloud command"     // Implementation example
}
```

## Backup and Safety

### Automatic Backups

The script creates automatic backups before making changes:

- **Backup naming**: `gcp_simplified_function_names.json.backup_YYYYMMDD_HHMMSS`
- **Backup location**: Same directory as original file
- **Backup content**: Complete copy of original database

### Recovery

To restore from backup:

```bash
# Find latest backup
ls -la gcp_simplified_function_names.json.backup_*

# Restore from backup
cp gcp_simplified_function_names.json.backup_YYYYMMDD_HHMMSS gcp_simplified_function_names.json
```

## Validation

### Verify Updates

After running the update script, verify the changes:

```bash
# Check total function count
grep -c '"function_name"' gcp_simplified_function_names.json

# Check for new Foundation functions
grep -c "iam_user_corporate_login_used\|cloudfunctions_environment_variables_secret_manager\|logging_sink_all_log_entries_configured" gcp_simplified_function_names.json
```

### Expected Results

- **Total functions**: 4,672 (was 4,662)
- **New functions**: 13 new Foundation functions
- **Renamed functions**: 0 functions updated
- **File size**: ~2.4MB (increased by ~2.5KB)

## Integration with Compliance Mapper

### Running the Mapper

After updating the database, you can run the compliance mapper again:

```bash
# Test mode (recommended first)
python3 gcp_compliance_mapper.py gcp_simplified_function_names.json CIS_GOOGLE_CLOUD_PLATFORM_FOUNDATION_BENCHMARK_V4.0.0.json --test 15

# Production mode
python3 gcp_compliance_mapper.py gcp_simplified_function_names.json CIS_GOOGLE_CLOUD_PLATFORM_FOUNDATION_BENCHMARK_V4.0.0.json
```

### Expected Improvements

With the updated database, the mapper should show:

- **Better coverage**: More existing functions mapped to compliance requirements
- **Fewer new functions needed**: Reduced gaps in coverage
- **Higher confidence scores**: Better quality mappings

## New Functions Added

### Identity & Access Management (3 functions)
1. `iam_user_corporate_login_used` - Corporate login credentials
2. `iam_project_no_service_account_roles` - Service account role restrictions
3. `iam_api_keys_host_app_restriction` - API key restrictions

### Security (2 functions)
4. `cloudfunctions_environment_variables_secret_manager` - Cloud Functions secrets
5. `cloud_asset_inventory_enabled` - Cloud Asset Inventory

### Monitoring & Logging (2 functions)
6. `logging_sink_all_log_entries_configured` - Log sink configuration
7. `logging_project_ownership_change_alert` - Ownership change alerts

### Security & Transparency (1 function)
8. `access_transparency_enabled` - Access Transparency

### Networking (3 functions)
9. `network_default_network_existence` - Default network checks
10. `compute_legacy_networks_absent` - Legacy network removal
11. `cloud_dns_dnssec_enabled` - DNS security

### Compute & Data (2 functions)
12. `compute_project_oslogin_enabled` - OS Login
13. `bigquery_table_data_classification_verified` - BigQuery data classification

## Troubleshooting

### Common Issues

1. **File not found errors**
   - Ensure you're in the correct directory
   - Check that output files exist in `output/` subdirectories

2. **JSON parsing errors**
   - Verify output files are valid JSON
   - Check for encoding issues

3. **No changes applied**
   - Functions may already exist in database
   - No rename suggestions may have been generated

### Debug Mode

Add debug logging to see detailed information:

```python
# In the update script, change logging level to DEBUG
logging.basicConfig(level=logging.DEBUG)
```

## Best Practices

1. **Always run in test mode first** when using the compliance mapper
2. **Review new functions** before applying updates
3. **Keep backups** of important database versions
4. **Validate changes** after each update
5. **Use the flexible script** for automatic file detection

## Comparison with GKE Benchmark

| Aspect | GKE Benchmark | Foundation Benchmark |
|--------|---------------|---------------------|
| **Total functions added** | 60 | 13 |
| **Functions renamed** | 5 | 0 |
| **Focus area** | GKE-specific security | General GCP security |
| **Compliance items** | 67 | 84 |
| **Coverage score** | 4.57/10 | 5.81/10 |

## Future Updates

When new compliance mapper runs generate additional output files:

1. **New functions**: Will be automatically detected and added
2. **Rename suggestions**: Will be automatically applied (if any)
3. **Backups**: Will be created for each update
4. **Validation**: Script will prevent duplicate additions

The flexible update script will automatically find the latest output files and apply all changes safely.
